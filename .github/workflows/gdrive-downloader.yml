name: Google Drive Downloader

on:
  workflow_call:
    inputs:
      gdrive-base-path:
        description: 'Google Drive„ÅÆ„Éô„Éº„Çπ„Éë„Çπ'
        required: true
        type: string
      artifact-name:
        description: '„Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„ÉàÂêç'
        required: false
        type: string
        default: 'gdrive-images'
    outputs:
      folder-name:
        description: 'ÂèñÂæó„Åó„Åü„Éï„Ç©„É´„ÉÄÂêç'
        value: ${{ jobs.download-images.outputs.folder-name }}

permissions:
  contents: write

jobs:
  download-images:
    runs-on: ubuntu-latest
    outputs:
      folder-name: ${{ steps.get-folder.outputs.folder-name }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install rclone
      run: |
        curl https://rclone.org/install.sh | sudo bash

    - name: Setup rclone config
      run: |
        mkdir -p ~/.config/rclone
        echo "${{ secrets.RCLONE_CONF_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

    - name: Get next folder
      id: get-folder
      run: |
        # ÂâçÂõû„ÅÆÁï™Âè∑„ÇíÂèñÂæó
        PREV_NUM=$(cat "previous file")
        echo "Previous number: $PREV_NUM"

        # „Éï„Ç©„É´„ÉÄ„ÅÆÊúÄÂ§ßÊï∞„ÇíÂèñÂæó
        MAX_NUM=$(rclone lsd "${{ inputs.gdrive-base-path }}" | wc -l | tr -d ' ')
        echo "Max folders: $MAX_NUM"

        # Ê¨°„ÅÆÁï™Âè∑ÔºàÊúÄÂ§ßÊï∞„ÇíË∂Ö„Åà„Åü„Çâ1„Å´Êàª„ÅôÔºâ
        NEXT_NUM=$((PREV_NUM + 1))
        if [ $NEXT_NUM -gt $MAX_NUM ]; then
          NEXT_NUM=1
          echo "Reached max, resetting to 1"
        fi
        echo "Next number: $NEXT_NUM"

        # „Éï„Ç©„É´„ÉÄ‰∏ÄË¶ß„ÇíÂèñÂæó„Åó„Å¶Ê¨°„ÅÆÁï™Âè∑„ÅÆ„Éï„Ç©„É´„ÉÄ„ÇíÊé¢„Åô
        FOLDER=$(rclone lsd "${{ inputs.gdrive-base-path }}" | grep "${NEXT_NUM}:" | awk '{print $NF}')

        if [ -z "$FOLDER" ]; then
          echo "‚ùå Folder with number $NEXT_NUM not found"
          exit 1
        fi

        echo "üìÅ Found folder: $FOLDER"
        echo "folder-name=$FOLDER" >> $GITHUB_OUTPUT
        echo "next-number=$NEXT_NUM" >> $GITHUB_OUTPUT

    - name: Update previous number
      run: |
        echo "${{ steps.get-folder.outputs.next-number }}" > "previous file"
        cat "previous file"

    - name: Commit and push updated number
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add "previous file"
        DATE=$(date +%Y-%m-%d)
        git commit -m "[$DATE] Update previous number to ${{ steps.get-folder.outputs.next-number }}"
        git push

    - name: Download from Google Drive
      run: |
        mkdir -p ./images
        FOLDER="${{ steps.get-folder.outputs.folder-name }}"
        rclone copy "${{ inputs.gdrive-base-path }}$FOLDER/" ./images/
        echo "üìÅ Downloaded files:"
        ls -la ./images/

    - name: Upload as artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.artifact-name }}
        path: ./images/
