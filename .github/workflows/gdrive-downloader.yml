name: Google Drive Downloader

on:
  workflow_call:
    inputs:
      gdrive-base-path:
        description: 'Google Driveã®ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹'
        required: true
        type: string
      artifact-name:
        description: 'ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå'
        required: false
        type: string
        default: 'gdrive-images'
    outputs:
      folder-name:
        description: 'å–å¾—ã—ãŸãƒ•ã‚©ãƒ«ãƒ€å'
        value: ${{ jobs.download-images.outputs.folder-name }}
      next-number:
        description: 'æ¬¡ã®ç•ªå·'
        value: ${{ jobs.download-images.outputs.next-number }}

permissions:
  contents: write

jobs:
  download-images:
    runs-on: ubuntu-latest
    outputs:
      folder-name: ${{ steps.get-folder.outputs.folder-name }}
      next-number: ${{ steps.get-folder.outputs.next-number }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install rclone
      run: |
        curl https://rclone.org/install.sh | sudo bash

    - name: Setup rclone config
      run: |
        mkdir -p ~/.config/rclone
        echo "${{ secrets.RCLONE_CONF_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

    - name: Get next folder
      id: get-folder
      run: |
        # å‰å›ã®ç•ªå·ã‚’å–å¾—
        PREV_NUM=$(cat "previous file")
        echo "Previous number: $PREV_NUM"

        # ãƒ•ã‚©ãƒ«ãƒ€ã®æœ€å¤§æ•°ã‚’å–å¾—
        MAX_NUM=$(rclone lsd "${{ inputs.gdrive-base-path }}" | wc -l | tr -d ' ')
        echo "Max folders: $MAX_NUM"

        # æ¬¡ã®ç•ªå·ï¼ˆæœ€å¤§æ•°ã‚’è¶…ãˆãŸã‚‰1ã«æˆ»ã™ï¼‰
        NEXT_NUM=$((PREV_NUM + 1))
        if [ $NEXT_NUM -gt $MAX_NUM ]; then
          NEXT_NUM=1
          echo "Reached max, resetting to 1"
        fi
        echo "Next number: $NEXT_NUM"

        # ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚’å–å¾—ã—ã¦æ¬¡ã®ç•ªå·ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¢ã™
        FOLDER=$(rclone lsd "${{ inputs.gdrive-base-path }}" | grep "${NEXT_NUM}:" | awk '{print $NF}')

        if [ -z "$FOLDER" ]; then
          echo "âŒ Folder with number $NEXT_NUM not found"
          exit 1
        fi

        echo "ğŸ“ Found folder: $FOLDER"
        echo "folder-name=$FOLDER" >> $GITHUB_OUTPUT
        echo "next-number=$NEXT_NUM" >> $GITHUB_OUTPUT

    - name: Download from Google Drive
      run: |
        mkdir -p ./images
        FOLDER="${{ steps.get-folder.outputs.folder-name }}"
        rclone copy "${{ inputs.gdrive-base-path }}$FOLDER/" ./images/
        echo "ğŸ“ Downloaded files:"
        ls -la ./images/

    - name: Upload as artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.artifact-name }}
        path: ./images/
