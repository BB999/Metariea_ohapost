name: OneDrive to Discord

on:
  # æ¯æœ6:50ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '50 21 * * *'  # UTC 21:50 = JST 6:50

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      debug:
        description: 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆXæŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰'
        required: false
        type: boolean
        default: false

jobs:
  download:
    uses: ./.github/workflows/onedrive-downloader.yml
    with:
      base-path: 'onedrive:XRC_ä»®æƒ³å¤§å­¦æ ¡/XRCãŠã¯ãƒ„ã‚¤/'
      artifact-name: 'onedrive-images'
    secrets: inherit

  post-to-x:
    uses: ./.github/workflows/x-poster.yml
    needs: download
    if: ${{ inputs.debug != true }}
    with:
      tweet-text: ${{ needs.download.outputs.greeting-message }}
      image-file: 'images/${{ needs.download.outputs.image-name }}'
    secrets: inherit

  move-and-update:
    uses: ./.github/workflows/onedrive-mover.yml
    needs: [download, post-to-x]
    if: always() && needs.download.result == 'success' && (needs.post-to-x.result == 'success' || needs.post-to-x.result == 'skipped')
    with:
      source-path: ${{ needs.download.outputs.folder-path }}
      image-name: ${{ needs.download.outputs.image-name }}
      dest-folder: 'æŠ•ç¨¿æ¸ˆã¿/'
    secrets: inherit

  send-to-discord:
    runs-on: ubuntu-latest
    needs: [download, post-to-x, move-and-update]
    if: always()

    steps:
    - name: Download images artifact
      uses: actions/download-artifact@v4
      with:
        name: onedrive-images
        path: ./images/
      continue-on-error: true

    - name: Check downloaded files
      run: |
        echo "ğŸ“ Downloaded files:"
        ls -la ./images/ || echo "ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ãªã—"

    - name: Report errors to Discord
      if: needs.download.result == 'failure' || needs.post-to-x.result == 'failure' || needs.move-and-update.result == 'failure'
      run: |
        ERROR_MSG="âŒ **ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ**\n\n"

        if [ "${{ needs.download.result }}" == "failure" ]; then
          ERROR_MSG="${ERROR_MSG}ğŸ”´ **ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—**: OneDriveã‹ã‚‰ã®ç”»åƒå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ\n"
        fi

        if [ "${{ needs.post-to-x.result }}" == "failure" ]; then
          ERROR_MSG="${ERROR_MSG}ğŸ”´ **XæŠ•ç¨¿å¤±æ•—**: Xã¸ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ\n"
        fi

        if [ "${{ needs.move-and-update.result }}" == "failure" ]; then
          ERROR_MSG="${ERROR_MSG}ğŸ”´ **ç”»åƒç§»å‹•ãƒ»ç•ªå·æ›´æ–°å¤±æ•—**: æŠ•ç¨¿æ¸ˆã¿ãƒ•ã‚©ãƒ«ãƒ€ã¸ã®ç§»å‹•ã¾ãŸã¯ç•ªå·æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ\n"
        fi

        curl -X POST \
          -H "Content-Type: application/json" \
          -d "{\"content\": \"$ERROR_MSG\"}" \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"

    - name: Send success message to Discord
      if: needs.download.result == 'success' && (needs.post-to-x.result == 'success' || needs.post-to-x.result == 'skipped') && needs.move-and-update.result == 'success'
      env:
        GREETING_MESSAGE: ${{ needs.download.outputs.greeting-message }}
      run: |
        RESULT=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
          -H "Content-Type: application/json" \
          -d "{\"content\": \"$GREETING_MESSAGE\"}" \
          "${{ secrets.DISCORD_WEBHOOK_URL }}")

        if [ "$RESULT" == "204" ] || [ "$RESULT" == "200" ]; then
          echo "âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æˆåŠŸ"
        else
          echo "âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å¤±æ•—: HTTP $RESULT"
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{"content": "âš ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"}' \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
        fi

    - name: Send image to Discord
      if: needs.download.result == 'success' && (needs.post-to-x.result == 'success' || needs.post-to-x.result == 'skipped') && needs.move-and-update.result == 'success'
      run: |
        IMAGE=$(find ./images -type f 2>/dev/null | head -n 1)

        if [ -n "$IMAGE" ]; then
          echo "ğŸ“· Found: $IMAGE"
          FILE_SIZE=$(stat -c%s "$IMAGE")
          echo "ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $FILE_SIZE bytes"

          # 8MBï¼ˆ8388608 bytesï¼‰ã‚’è¶…ãˆã‚‹å ´åˆã¯åœ§ç¸®
          if [ "$FILE_SIZE" -gt 8388608 ]; then
            echo "âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ãŒ8MBã‚’è¶…ãˆã¦ã„ã‚‹ãŸã‚åœ§ç¸®ã—ã¾ã™"
            sudo apt-get install -y imagemagick > /dev/null 2>&1
            COMPRESSED_IMAGE="./images/compressed_$(basename "$IMAGE" | sed 's/\.[^.]*$//').jpg"
            convert "$IMAGE" -resize 1920x1080\> -quality 85 "$COMPRESSED_IMAGE"
            IMAGE="$COMPRESSED_IMAGE"
            NEW_SIZE=$(stat -c%s "$IMAGE")
            echo "ğŸ“Š åœ§ç¸®å¾Œã‚µã‚¤ã‚º: $NEW_SIZE bytes"
          fi

          echo "ğŸ“· Sending: $IMAGE"
          RESULT=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -F "file=@$IMAGE" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}")

          if [ "$RESULT" == "200" ]; then
            echo "âœ… ç”»åƒé€ä¿¡æˆåŠŸ"
          else
            echo "âŒ ç”»åƒé€ä¿¡å¤±æ•—: HTTP $RESULT"
            curl -X POST \
              -H "Content-Type: application/json" \
              -d '{"content": "âš ï¸ ç”»åƒé€ä¿¡ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆHTTP '$RESULT'ï¼‰"}' \
              "${{ secrets.DISCORD_WEBHOOK_URL }}"
          fi
        else
          echo "âŒ No image found"
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{"content": "âš ï¸ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"}' \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
        fi

    - name: Send completion report to Discord
      if: needs.download.result == 'success' && (needs.post-to-x.result == 'success' || needs.post-to-x.result == 'skipped') && needs.move-and-update.result == 'success'
      env:
        POST_TO_X_RESULT: ${{ needs.post-to-x.result }}
      run: |
        REPORT="âœ… **å‡¦ç†å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ**\n\n"
        REPORT="${REPORT}ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: æˆåŠŸ\n"
        if [ "$POST_TO_X_RESULT" == "skipped" ]; then
          REPORT="${REPORT}ğŸ¦ XæŠ•ç¨¿: ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼‰\n"
        else
          REPORT="${REPORT}ğŸ¦ XæŠ•ç¨¿: æˆåŠŸ\n"
        fi
        REPORT="${REPORT}ğŸ“ ç”»åƒç§»å‹•: æˆåŠŸ\n"
        REPORT="${REPORT}ğŸ”¢ ç•ªå·æ›´æ–°: æˆåŠŸ\n"
        REPORT="${REPORT}ğŸ’¬ Discordé€ä¿¡: æˆåŠŸ"

        curl -X POST \
          -H "Content-Type: application/json" \
          -d "{\"content\": \"$REPORT\"}" \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"

  commit-push:
    uses: ./.github/workflows/commit-pusher.yml
    needs: [download, post-to-x, move-and-update, send-to-discord]
    if: always() && needs.download.result == 'success' && (needs.post-to-x.result == 'success' || needs.post-to-x.result == 'skipped') && needs.move-and-update.result == 'success'
    with:
      next-number: ${{ needs.download.outputs.next-number }}
    secrets: inherit
