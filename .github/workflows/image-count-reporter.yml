name: Image Count Reporter

on:
  # æ¯é€±æ—¥æ›œæ—¥7æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ã«è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '0 22 * * 6'  # UTC 22:00ï¼ˆåœŸæ›œæ—¥ï¼‰= JST 7:00ï¼ˆæ—¥æ›œæ—¥ï¼‰

  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
    - name: Install rclone
      run: |
        curl https://rclone.org/install.sh | sudo bash

    - name: Setup rclone config
      run: |
        mkdir -p ~/.config/rclone
        echo "${{ secrets.RCLONE_CONF_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

    - name: Count images in each folder
      id: count
      run: |
        BASE_PATH="onedrive:XRC_ä»®æƒ³å¤§å­¦æ ¡/XRCãŠã¯ãƒ„ã‚¤/"

        # ç•ªå·+åå‰å½¢å¼ã®ãƒ•ã‚©ãƒ«ãƒ€ã®ã¿å–å¾—
        FOLDERS=$(rclone lsd "$BASE_PATH" | awk '{print $NF}' | grep -E "^[0-9]{2}.+" | sort)

        echo "ğŸ“Š å„ãƒ•ã‚©ãƒ«ãƒ€ã®æŠ•ç¨¿å‰ç”»åƒæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆä¸­..."

        REPORT="ğŸ“Š **ãŠã¯ãƒ„ã‚¤ç”»åƒæ•°ãƒ¬ãƒãƒ¼ãƒˆ**\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        TOTAL=0

        while IFS= read -r FOLDER; do
          if [ -n "$FOLDER" ]; then
            COUNT=$(rclone ls "${BASE_PATH}${FOLDER}/æŠ•ç¨¿å‰/" 2>/dev/null | grep -iE '\.(jpg|jpeg|png|gif|webp)$' | wc -l | tr -d ' ')
            REPORT="${REPORT}${FOLDER}: ${COUNT}æš\n"
            TOTAL=$((TOTAL + COUNT))
            echo "  ${FOLDER}: ${COUNT}æš"
          fi
        done <<< "$FOLDERS"

        REPORT="${REPORT}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“¦ åˆè¨ˆ: ${TOTAL}æš"

        echo "report<<EOF" >> $GITHUB_OUTPUT
        echo -e "$REPORT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        echo ""
        echo "âœ… ã‚«ã‚¦ãƒ³ãƒˆå®Œäº† (åˆè¨ˆ: ${TOTAL}æš)"

    - name: Send report to Discord
      env:
        REPORT: ${{ steps.count.outputs.report }}
      run: |
        # jqã‚’ä½¿ã£ã¦JSONã‚’æ­£ã—ãã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        JSON_PAYLOAD=$(jq -n --arg content "$REPORT" '{content: $content}')

        curl -X POST \
          -H "Content-Type: application/json" \
          -d "$JSON_PAYLOAD" \
          "${{ secrets.DISCORD_WEBHOOK_URL_METARIEA }}"

        echo "âœ… Discordã«ãƒ¬ãƒãƒ¼ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ"
