name: Google Drive to Discord

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆXæŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰'
        required: false
        type: boolean
        default: false

jobs:
  download:
    uses: ./.github/workflows/gdrive-downloader.yml
    with:
      gdrive-base-path: 'gdrive:metariea/ãŠã¯ãƒ„ã‚¤æŠ•ç¨¿å‰/'
      artifact-name: 'gdrive-images'
    secrets: inherit

  post-to-x:
    uses: ./.github/workflows/x-poster.yml
    needs: download
    if: ${{ inputs.debug != true }}
    with:
      tweet-text: 'ã“ã‚“ã«ã¡ã¯'
      image-file: 'images/${{ needs.download.outputs.image-name }}'
    secrets: inherit

  move-and-update:
    uses: ./.github/workflows/gdrive-mover.yml
    needs: [download, post-to-x]
    if: always() && needs.download.result == 'success' && (needs.post-to-x.result == 'success' || needs.post-to-x.result == 'skipped')
    with:
      source-path: ${{ needs.download.outputs.folder-path }}
      image-name: ${{ needs.download.outputs.image-name }}
      dest-path: 'gdrive:metariea/ãŠã¯ãƒ„ã‚¤æŠ•ç¨¿æ¸ˆã¿/'
    secrets: inherit

  send-to-discord:
    runs-on: ubuntu-latest
    needs: [download, post-to-x, move-and-update]
    if: always()

    steps:
    - name: Download images artifact
      uses: actions/download-artifact@v4
      with:
        name: gdrive-images
        path: ./images/
      continue-on-error: true

    - name: Check downloaded files
      run: |
        echo "ğŸ“ Downloaded files:"
        ls -la ./images/ || echo "ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ãªã—"

    - name: Report errors to Discord
      if: needs.download.result == 'failure' || needs.post-to-x.result == 'failure' || needs.move-and-update.result == 'failure'
      run: |
        ERROR_MSG="âŒ **ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ**\n\n"

        if [ "${{ needs.download.result }}" == "failure" ]; then
          ERROR_MSG="${ERROR_MSG}ğŸ”´ **ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—**: Google Driveã‹ã‚‰ã®ç”»åƒå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ\n"
        fi

        if [ "${{ needs.post-to-x.result }}" == "failure" ]; then
          ERROR_MSG="${ERROR_MSG}ğŸ”´ **XæŠ•ç¨¿å¤±æ•—**: Xã¸ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ\n"
        fi

        if [ "${{ needs.move-and-update.result }}" == "failure" ]; then
          ERROR_MSG="${ERROR_MSG}ğŸ”´ **ç”»åƒç§»å‹•ãƒ»ç•ªå·æ›´æ–°å¤±æ•—**: æŠ•ç¨¿æ¸ˆã¿ãƒ•ã‚©ãƒ«ãƒ€ã¸ã®ç§»å‹•ã¾ãŸã¯ç•ªå·æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ\n"
        fi

        curl -X POST \
          -H "Content-Type: application/json" \
          -d "{\"content\": \"$ERROR_MSG\"}" \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"

    - name: Send success message to Discord
      if: needs.download.result == 'success' && (needs.post-to-x.result == 'success' || needs.post-to-x.result == 'skipped') && needs.move-and-update.result == 'success'
      run: |
        RESULT=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
          -H "Content-Type: application/json" \
          -d '{"content": "ã“ã‚“ã«ã¡ã¯"}' \
          "${{ secrets.DISCORD_WEBHOOK_URL }}")

        if [ "$RESULT" == "204" ] || [ "$RESULT" == "200" ]; then
          echo "âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æˆåŠŸ"
        else
          echo "âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å¤±æ•—: HTTP $RESULT"
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{"content": "âš ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"}' \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
        fi

    - name: Send image to Discord
      if: needs.download.result == 'success' && (needs.post-to-x.result == 'success' || needs.post-to-x.result == 'skipped') && needs.move-and-update.result == 'success'
      run: |
        IMAGE=$(find ./images -type f 2>/dev/null | head -n 1)

        if [ -n "$IMAGE" ]; then
          echo "ğŸ“· Sending: $IMAGE"
          RESULT=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -F "file=@$IMAGE" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}")

          if [ "$RESULT" == "200" ]; then
            echo "âœ… ç”»åƒé€ä¿¡æˆåŠŸ"
          else
            echo "âŒ ç”»åƒé€ä¿¡å¤±æ•—: HTTP $RESULT"
            curl -X POST \
              -H "Content-Type: application/json" \
              -d '{"content": "âš ï¸ ç”»åƒé€ä¿¡ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"}' \
              "${{ secrets.DISCORD_WEBHOOK_URL }}"
          fi
        else
          echo "âŒ No image found"
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{"content": "âš ï¸ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"}' \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
        fi

    - name: Send completion report to Discord
      if: needs.download.result == 'success' && (needs.post-to-x.result == 'success' || needs.post-to-x.result == 'skipped') && needs.move-and-update.result == 'success'
      env:
        POST_TO_X_RESULT: ${{ needs.post-to-x.result }}
      run: |
        REPORT="âœ… **å‡¦ç†å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ**\n\n"
        REPORT="${REPORT}ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: æˆåŠŸ\n"
        if [ "$POST_TO_X_RESULT" == "skipped" ]; then
          REPORT="${REPORT}ğŸ¦ XæŠ•ç¨¿: ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼‰\n"
        else
          REPORT="${REPORT}ğŸ¦ XæŠ•ç¨¿: æˆåŠŸ\n"
        fi
        REPORT="${REPORT}ğŸ“ ç”»åƒç§»å‹•: æˆåŠŸ\n"
        REPORT="${REPORT}ğŸ”¢ ç•ªå·æ›´æ–°: æˆåŠŸ\n"
        REPORT="${REPORT}ğŸ’¬ Discordé€ä¿¡: æˆåŠŸ"

        curl -X POST \
          -H "Content-Type: application/json" \
          -d "{\"content\": \"$REPORT\"}" \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"

  commit-push:
    uses: ./.github/workflows/commit-pusher.yml
    needs: [download, send-to-discord]
    if: needs.send-to-discord.result == 'success'
    with:
      next-number: ${{ needs.download.outputs.next-number }}
    secrets: inherit
