name: Google Drive to Discord

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œç”¨

jobs:
  download:
    uses: ./.github/workflows/gdrive-downloader.yml
    with:
      gdrive-base-path: 'gdrive:metariea/ãŠã¯ãƒ„ã‚¤æŠ•ç¨¿å‰/'
      artifact-name: 'gdrive-images'
    secrets: inherit

  send-to-discord:
    runs-on: ubuntu-latest
    needs: download
    outputs:
      next-number: ${{ needs.download.outputs.next-number }}
      image-name: ${{ needs.download.outputs.image-name }}
      folder-path: ${{ needs.download.outputs.folder-path }}

    steps:
    - name: Download images artifact
      uses: actions/download-artifact@v4
      with:
        name: gdrive-images
        path: ./images/

    - name: Check downloaded files
      run: |
        echo "ğŸ“ Downloaded files:"
        ls -la ./images/

    - name: Send message to Discord
      run: |
        curl -X POST \
          -H "Content-Type: application/json" \
          -d '{"content": "ã“ã‚“ã«ã¡ã¯"}' \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"

    - name: Send image to Discord
      run: |
        IMAGE=$(find ./images -type f | head -n 1)

        if [ -n "$IMAGE" ]; then
          echo "ğŸ“· Sending: $IMAGE"
          curl -X POST \
            -F "file=@$IMAGE" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
          echo "âœ… Done!"
        else
          echo "âŒ No image found"
          exit 1
        fi

  move-image:
    uses: ./.github/workflows/gdrive-mover.yml
    needs: send-to-discord
    with:
      source-path: ${{ needs.send-to-discord.outputs.folder-path }}
      image-name: ${{ needs.send-to-discord.outputs.image-name }}
      dest-path: 'gdrive:metariea/ãŠã¯ãƒ„ã‚¤æŠ•ç¨¿æ¸ˆã¿/'
    secrets: inherit

  commit-push:
    uses: ./.github/workflows/commit-pusher.yml
    needs: [send-to-discord, move-image]
    with:
      next-number: ${{ needs.send-to-discord.outputs.next-number }}
    secrets: inherit
