name: Google Drive to Discord

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œç”¨

jobs:
  download:
    uses: ./.github/workflows/gdrive-downloader.yml
    with:
      gdrive-path: 'gdrive:metariea/ohatui/'
      artifact-name: 'gdrive-images'
    secrets: inherit

  send-to-discord:
    runs-on: ubuntu-latest
    needs: download

    steps:
    - name: Download images artifact
      uses: actions/download-artifact@v4
      with:
        name: gdrive-images
        path: ./images/

    - name: Check downloaded files
      run: |
        echo "ğŸ“ Downloaded files:"
        ls -la ./images/

    - name: Send message to Discord
      run: |
        curl -X POST \
          -H "Content-Type: application/json" \
          -d '{"content": "ã“ã‚“ã«ã¡ã¯"}' \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"

    - name: Send random image to Discord
      run: |
        # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«1æšé¸æŠ
        IMAGE=$(find ./images -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" \) | shuf -n 1)

        if [ -n "$IMAGE" ]; then
          echo "ğŸ“· Sending: $IMAGE"
          curl -X POST \
            -F "file=@$IMAGE" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
          echo "âœ… Done!"
        else
          echo "âŒ No image found"
          exit 1
        fi
