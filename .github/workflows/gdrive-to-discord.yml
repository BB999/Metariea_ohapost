name: Google Drive to Discord

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œç”¨

jobs:
  download:
    runs-on: ubuntu-latest
    outputs:
      folder-name: ${{ steps.get-folder.outputs.folder-name }}
      next-number: ${{ steps.get-folder.outputs.next-number }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install rclone
      run: |
        curl https://rclone.org/install.sh | sudo bash

    - name: Setup rclone config
      run: |
        mkdir -p ~/.config/rclone
        echo "${{ secrets.RCLONE_CONF_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

    - name: Get next folder
      id: get-folder
      run: |
        # å‰å›ã®ç•ªå·ã‚’å–å¾—
        PREV_NUM=$(cat "previous file")
        echo "Previous number: $PREV_NUM"

        # æ¬¡ã®ç•ªå·
        NEXT_NUM=$((PREV_NUM + 1))
        echo "Next number: $NEXT_NUM"

        # ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚’å–å¾—ã—ã¦æ¬¡ã®ç•ªå·ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¢ã™
        FOLDER=$(rclone lsd "gdrive:metariea/ãŠã¯ãƒ„ã‚¤æŠ•ç¨¿å‰/" | grep "^ *-1 ${NEXT_NUM}:" | awk '{print $NF}')

        if [ -z "$FOLDER" ]; then
          echo "âŒ Folder with number $NEXT_NUM not found"
          exit 1
        fi

        echo "ğŸ“ Found folder: $FOLDER"
        echo "folder-name=$FOLDER" >> $GITHUB_OUTPUT
        echo "next-number=$NEXT_NUM" >> $GITHUB_OUTPUT

    - name: Download images from Google Drive
      run: |
        mkdir -p ./images
        FOLDER="${{ steps.get-folder.outputs.folder-name }}"
        rclone copy "gdrive:metariea/ãŠã¯ãƒ„ã‚¤æŠ•ç¨¿å‰/$FOLDER/" ./images/
        echo "ğŸ“ Downloaded files:"
        ls -la ./images/

    - name: Upload images as artifact
      uses: actions/upload-artifact@v4
      with:
        name: gdrive-images
        path: ./images/

  send-to-discord:
    runs-on: ubuntu-latest
    needs: download

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download images artifact
      uses: actions/download-artifact@v4
      with:
        name: gdrive-images
        path: ./images/

    - name: Check downloaded files
      run: |
        echo "ğŸ“ Downloaded files:"
        ls -la ./images/

    - name: Update previous number
      run: |
        echo "${{ needs.download.outputs.next-number }}" > "previous file"
        cat "previous file"

    - name: Commit and push updated number
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add "previous file"
        git commit -m "Update previous number to ${{ needs.download.outputs.next-number }}"
        git push

    - name: Send message to Discord
      run: |
        curl -X POST \
          -H "Content-Type: application/json" \
          -d '{"content": "ã“ã‚“ã«ã¡ã¯"}' \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"

    - name: Send random image to Discord
      run: |
        # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«1æšé¸æŠ
        IMAGE=$(find ./images -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" \) | shuf -n 1)

        if [ -n "$IMAGE" ]; then
          echo "ğŸ“· Sending: $IMAGE"
          curl -X POST \
            -F "file=@$IMAGE" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
          echo "âœ… Done!"
        else
          echo "âŒ No image found"
          exit 1
        fi
