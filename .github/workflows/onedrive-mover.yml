name: OneDrive Mover

on:
  workflow_call:
    inputs:
      source-path:
        description: 'ç§»å‹•å…ƒã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ï¼ˆæŠ•ç¨¿å‰ãƒ•ã‚©ãƒ«ãƒ€ï¼‰'
        required: true
        type: string
      image-name:
        description: 'ç§»å‹•ã™ã‚‹ç”»åƒå'
        required: true
        type: string
      dest-folder:
        description: 'ç§»å‹•å…ˆã®ãƒ•ã‚©ãƒ«ãƒ€åï¼ˆä¾‹: æŠ•ç¨¿æ¸ˆã¿/ï¼‰'
        required: true
        type: string


jobs:
  move-image:
    runs-on: ubuntu-latest

    steps:
    - name: Install rclone
      run: |
        curl https://rclone.org/install.sh | sudo bash

    - name: Setup rclone config
      run: |
        mkdir -p ~/.config/rclone
        echo "${{ secrets.RCLONE_CONF_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

    - name: Move image to destination
      run: |
        DATE=$(TZ='Asia/Tokyo' date +%Y-%m-%d)
        SOURCE="${{ inputs.source-path }}${{ inputs.image-name }}"

        # æŠ•ç¨¿å‰ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹ã‹ã‚‰æŠ•ç¨¿æ¸ˆã¿ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹ã‚’ä½œæˆ
        # ä¾‹: onedrive:XRC_ä»®æƒ³å¤§å­¦æ ¡/ãŠã¯ãƒ„ã‚¤/1:åå‰/æŠ•ç¨¿å‰/ â†’ onedrive:XRC_ä»®æƒ³å¤§å­¦æ ¡/ãŠã¯ãƒ„ã‚¤/1:åå‰/æŠ•ç¨¿æ¸ˆã¿/
        BASE_PATH=$(echo "${{ inputs.source-path }}" | sed 's|æŠ•ç¨¿å‰/$||')
        DEST="${BASE_PATH}${{ inputs.dest-folder }}${DATE}_${{ inputs.image-name }}"

        echo "ğŸ“¦ Moving: $SOURCE"
        echo "ğŸ“ To: $DEST"

        # ã‚³ãƒ”ãƒ¼ã—ã¦ã‹ã‚‰å‰Šé™¤ï¼ˆmoveãŒã†ã¾ãã„ã‹ãªã„å ´åˆã®å¯¾ç­–ï¼‰
        rclone copyto "$SOURCE" "$DEST"
        rclone delete "$SOURCE"

        echo "âœ… ç”»åƒç§»å‹•å®Œäº†!"
