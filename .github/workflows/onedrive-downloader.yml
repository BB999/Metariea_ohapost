name: OneDrive Downloader

on:
  workflow_call:
    inputs:
      base-path:
        description: 'OneDriveã®ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ï¼ˆä¾‹: onedrive:XRC_ä»®æƒ³å¤§å­¦æ ¡/ãŠã¯ãƒ„ã‚¤/ï¼‰'
        required: true
        type: string
      artifact-name:
        description: 'ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå'
        required: false
        type: string
        default: 'onedrive-images'
    outputs:
      folder-name:
        description: 'å–å¾—ã—ãŸãƒ•ã‚©ãƒ«ãƒ€å'
        value: ${{ jobs.download-images.outputs.folder-name }}
      next-number:
        description: 'æ¬¡ã®ç•ªå·'
        value: ${{ jobs.download-images.outputs.next-number }}
      image-name:
        description: 'é¸æŠã—ãŸç”»åƒå'
        value: ${{ jobs.download-images.outputs.image-name }}
      folder-path:
        description: 'ç”»åƒã®ã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ï¼ˆæŠ•ç¨¿å‰ãƒ•ã‚©ãƒ«ãƒ€ï¼‰'
        value: ${{ jobs.download-images.outputs.folder-path }}
      greeting-message:
        description: 'ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚ŒãŸæŒ¨æ‹¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'
        value: ${{ jobs.download-images.outputs.greeting-message }}

permissions:
  contents: write

jobs:
  download-images:
    runs-on: ubuntu-latest
    outputs:
      folder-name: ${{ steps.get-folder.outputs.folder-name }}
      next-number: ${{ steps.get-folder.outputs.next-number }}
      image-name: ${{ steps.select-image.outputs.image-name }}
      folder-path: ${{ steps.select-image.outputs.folder-path }}
      greeting-message: ${{ steps.select-greeting.outputs.message }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install rclone
      run: |
        curl https://rclone.org/install.sh | sudo bash

    - name: Setup rclone config
      run: |
        mkdir -p ~/.config/rclone
        echo "${{ secrets.RCLONE_CONF_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

    - name: Find folder with images and download
      id: get-folder
      run: |
        # å‰å›ã®ç•ªå·ã‚’å–å¾—
        PREV_NUM=$(cat "previous file")
        echo "Previous number: $PREV_NUM"

        # ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚’å–å¾—ï¼ˆç•ªå·ä»˜ããƒ•ã‚©ãƒ«ãƒ€ã®ã¿ã€etcãªã©ã¯é™¤å¤–ï¼‰
        FOLDERS=$(rclone lsd "${{ inputs.base-path }}" | awk '{print $NF}' | grep "^[0-9]" | sort)
        MAX_NUM=$(echo "$FOLDERS" | wc -l | tr -d ' ')
        echo "Max folders: $MAX_NUM"

        if [ "$MAX_NUM" -eq 0 ]; then
          echo "âŒ No numbered folders found"
          exit 1
        fi

        # ç”»åƒãŒã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—
        CHECKED=0
        CURRENT_NUM=$PREV_NUM
        START_NUM=$((PREV_NUM + 1))
        if [ $START_NUM -gt $MAX_NUM ]; then
          START_NUM=1
        fi
        FOUND=false

        while [ $CHECKED -lt $MAX_NUM ]; do
          # æ¬¡ã®ç•ªå·ï¼ˆæœ€å¤§æ•°ã‚’è¶…ãˆãŸã‚‰1ã«æˆ»ã™ï¼‰
          CURRENT_NUM=$((CURRENT_NUM + 1))
          if [ $CURRENT_NUM -gt $MAX_NUM ]; then
            CURRENT_NUM=1
            echo "ğŸ”„ Reached max, resetting to 1"
          fi

          # ä¸€å‘¨ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
          if [ $CHECKED -gt 0 ] && [ $CURRENT_NUM -eq $START_NUM ]; then
            echo "âŒ Checked all folders, no images found"
            exit 1
          fi

          echo "ğŸ” Checking folder number: $CURRENT_NUM"

          # ç•ªå·ã‚’2æ¡ã«ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
          NUM_PADDED=$(printf "%02d" $CURRENT_NUM)
          FOLDER=$(echo "$FOLDERS" | grep "^${NUM_PADDED}" | head -n 1)

          if [ -z "$FOLDER" ]; then
            echo "âš ï¸ Folder with number $CURRENT_NUM not found, skipping..."
            CHECKED=$((CHECKED + 1))
            continue
          fi

          echo "ğŸ“ Found folder: $FOLDER"

          # æŠ•ç¨¿å‰ãƒ•ã‚©ãƒ«ãƒ€ã«ç”»åƒãŒã‚ã‚‹ã‹ç¢ºèª
          SOURCE_PATH="${{ inputs.base-path }}$FOLDER/æŠ•ç¨¿å‰/"
          IMAGE_COUNT=$(rclone ls "$SOURCE_PATH" 2>/dev/null | wc -l | tr -d ' ')

          if [ "$IMAGE_COUNT" -gt 0 ]; then
            echo "âœ… Found $IMAGE_COUNT image(s) in $FOLDER/æŠ•ç¨¿å‰/"
            FOUND=true

            # å‡ºåŠ›ã‚’è¨­å®š
            {
              echo "folder-name<<EOF"
              echo "$FOLDER"
              echo "EOF"
              echo "next-number=$CURRENT_NUM"
            } >> $GITHUB_OUTPUT

            break
          else
            echo "âš ï¸ No images in $FOLDER/æŠ•ç¨¿å‰/, skipping..."
          fi

          CHECKED=$((CHECKED + 1))
        done

        # ç”»åƒãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆ
        if [ "$FOUND" = false ]; then
          echo "âŒ No images found in any folder"
          exit 1
        fi

    - name: Select and download random image
      id: select-image
      run: |
        mkdir -p ./images
        FOLDER="${{ steps.get-folder.outputs.folder-name }}"

        # æŠ•ç¨¿å‰ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹
        SOURCE_PATH="${{ inputs.base-path }}$FOLDER/æŠ•ç¨¿å‰/"
        echo "ğŸ“‚ Source path: $SOURCE_PATH"

        # ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸æŠ
        IMAGE=$(rclone ls "$SOURCE_PATH" | awk '{print $2}' | shuf -n 1)

        if [ -z "$IMAGE" ]; then
          echo "âŒ No image found in folder"
          exit 1
        fi

        echo "ğŸ“· Selected image: $IMAGE"

        # é¸æŠã—ãŸç”»åƒã ã‘ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        rclone copy "$SOURCE_PATH$IMAGE" ./images/

        echo "ğŸ“ Downloaded file:"
        ls -la ./images/

        # å‡ºåŠ›
        {
          echo "image-name<<EOF"
          echo "$IMAGE"
          echo "EOF"
          echo "folder-path<<EOF2"
          echo "$SOURCE_PATH"
          echo "EOF2"
        } >> $GITHUB_OUTPUT

    - name: Select random greeting message
      id: select-greeting
      run: |
        MESSAGES=(
          "ãŠã¯ã‚ˆã†ãƒ¼ã€‚"
          "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚"
          "ãŠã¯ã‚ˆï½ã€‚"
          "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼"
          "Good morning!!"
          "ãŠã¯ã‚ˆã†ã€‚"
          "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ãƒ¼ã™ã€‚"
          "ãŠã¯ã‚ˆï¼"
          "ãŠã¯ã‚ˆãƒ¼ã”ã–ã„ã¾ã™ã€‚"
          "Good morning."
          "ãŠã¯ã‚ˆã†ãƒ¼"
          "ãŠã¯ã‚ˆï¼"
          "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ãƒ¼ã™"
          "Good morning!"
        )

        # ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸æŠ
        RANDOM_INDEX=$((RANDOM % ${#MESSAGES[@]}))
        SELECTED="${MESSAGES[$RANDOM_INDEX]}"

        echo "ğŸ“ Selected greeting: $SELECTED"
        echo "message=$SELECTED" >> $GITHUB_OUTPUT

    - name: Upload as artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.artifact-name }}
        path: ./images/
