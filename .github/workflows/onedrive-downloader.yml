name: OneDrive Downloader

on:
  workflow_call:
    inputs:
      base-path:
        description: 'OneDriveã®ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ï¼ˆä¾‹: onedrive:XRC_ä»®æƒ³å¤§å­¦æ ¡/ãŠã¯ãƒ„ã‚¤/ï¼‰'
        required: true
        type: string
      artifact-name:
        description: 'ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆå'
        required: false
        type: string
        default: 'onedrive-images'
    outputs:
      folder-name:
        description: 'å–å¾—ã—ãŸãƒ•ã‚©ãƒ«ãƒ€å'
        value: ${{ jobs.download-images.outputs.folder-name }}
      next-number:
        description: 'æ¬¡ã®ç•ªå·'
        value: ${{ jobs.download-images.outputs.next-number }}
      image-name:
        description: 'é¸æŠã—ãŸç”»åƒå'
        value: ${{ jobs.download-images.outputs.image-name }}
      folder-path:
        description: 'ç”»åƒã®ã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ï¼ˆæŠ•ç¨¿å‰ãƒ•ã‚©ãƒ«ãƒ€ï¼‰'
        value: ${{ jobs.download-images.outputs.folder-path }}
      greeting-message:
        description: 'ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã°ã‚ŒãŸæŒ¨æ‹¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'
        value: ${{ jobs.download-images.outputs.greeting-message }}

permissions:
  contents: write

jobs:
  download-images:
    runs-on: ubuntu-latest
    outputs:
      folder-name: ${{ steps.get-folder.outputs.folder-name }}
      next-number: ${{ steps.get-folder.outputs.next-number }}
      image-name: ${{ steps.select-image.outputs.image-name }}
      folder-path: ${{ steps.select-image.outputs.folder-path }}
      greeting-message: ${{ steps.select-greeting.outputs.message }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install rclone
      run: |
        curl https://rclone.org/install.sh | sudo bash

    - name: Setup rclone config
      run: |
        mkdir -p ~/.config/rclone
        echo "${{ secrets.RCLONE_CONF_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

    - name: Get next folder
      id: get-folder
      run: |
        # å‰å›ã®ç•ªå·ã‚’å–å¾—
        PREV_NUM=$(cat "previous file")
        echo "Previous number: $PREV_NUM"

        # ãƒ•ã‚©ãƒ«ãƒ€ã®æœ€å¤§æ•°ã‚’å–å¾—
        MAX_NUM=$(rclone lsd "${{ inputs.base-path }}" | wc -l | tr -d ' ')
        echo "Max folders: $MAX_NUM"

        # æ¬¡ã®ç•ªå·ï¼ˆæœ€å¤§æ•°ã‚’è¶…ãˆãŸã‚‰1ã«æˆ»ã™ï¼‰
        NEXT_NUM=$((PREV_NUM + 1))
        if [ $NEXT_NUM -gt $MAX_NUM ]; then
          NEXT_NUM=1
          echo "Reached max, resetting to 1"
        fi
        echo "Next number: $NEXT_NUM"

        # ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚’å–å¾—ã—ã¦æ¬¡ã®ç•ªå·ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¢ã™ï¼ˆ02ã®ã‚‰ã­ã“ã³ ã®ã‚ˆã†ãªå½¢å¼ã«å¯¾å¿œï¼‰
        # ç•ªå·ã‚’2æ¡ã«ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
        NEXT_NUM_PADDED=$(printf "%02d" $NEXT_NUM)
        FOLDER=$(rclone lsd "${{ inputs.base-path }}" | awk '{print $NF}' | grep "^${NEXT_NUM_PADDED}" | head -n 1)

        if [ -z "$FOLDER" ]; then
          echo "âŒ Folder with number $NEXT_NUM not found"
          exit 1
        fi

        echo "ğŸ“ Found folder: $FOLDER"
        {
          echo "folder-name<<EOF"
          echo "$FOLDER"
          echo "EOF"
          echo "next-number=$NEXT_NUM"
        } >> $GITHUB_OUTPUT

    - name: Select and download random image
      id: select-image
      run: |
        mkdir -p ./images
        FOLDER="${{ steps.get-folder.outputs.folder-name }}"

        # æŠ•ç¨¿å‰ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹
        SOURCE_PATH="${{ inputs.base-path }}$FOLDER/æŠ•ç¨¿å‰/"
        echo "ğŸ“‚ Source path: $SOURCE_PATH"

        # ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸æŠ
        IMAGE=$(rclone ls "$SOURCE_PATH" | awk '{print $2}' | shuf -n 1)

        if [ -z "$IMAGE" ]; then
          echo "âŒ No image found in folder"
          exit 1
        fi

        echo "ğŸ“· Selected image: $IMAGE"

        # é¸æŠã—ãŸç”»åƒã ã‘ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        rclone copy "$SOURCE_PATH$IMAGE" ./images/

        echo "ğŸ“ Downloaded file:"
        ls -la ./images/

        # å‡ºåŠ›
        {
          echo "image-name<<EOF"
          echo "$IMAGE"
          echo "EOF"
          echo "folder-path<<EOF2"
          echo "$SOURCE_PATH"
          echo "EOF2"
        } >> $GITHUB_OUTPUT

    - name: Select random greeting message
      id: select-greeting
      run: |
        MESSAGES=(
          "ãŠã¯ã‚ˆã†ãƒ¼ã€‚"
          "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚"
          "ãŠã¯ã‚ˆï½ã€‚"
          "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼"
          "Good morning!!"
          "ãŠã¯ã‚ˆã†ã€‚"
          "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ãƒ¼ã™ã€‚"
          "ãŠã¯ã‚ˆï¼"
          "ãŠã¯ã‚ˆãƒ¼ã”ã–ã„ã¾ã™ã€‚"
          "Good morning."
          "ãŠã¯ã‚ˆã†ãƒ¼"
          "ãŠã¯ã‚ˆï¼"
          "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ãƒ¼ã™"
          "Good morning!"
        )

        # ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸æŠ
        RANDOM_INDEX=$((RANDOM % ${#MESSAGES[@]}))
        SELECTED="${MESSAGES[$RANDOM_INDEX]}"

        echo "ğŸ“ Selected greeting: $SELECTED"
        echo "message=$SELECTED" >> $GITHUB_OUTPUT

    - name: Upload as artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.artifact-name }}
        path: ./images/
